import pickle
import random
import heapq
#Cluster of 1000 documents, cluster size=28
#clusters=[[2, 10, 55, 94, 145, 191, 203, 265, 275, 329, 348, 352, 465, 474, 565, 665, 674, 676, 693, 772, 777, 779, 806, 813, 823, 845, 849, 859, 873, 903, 928, 946], [12, 20, 24, 36, 37, 73, 97, 101, 116, 137, 177, 182, 261, 280, 283, 286, 311, 313, 320, 366, 395, 402, 405, 426, 431, 433, 442, 491, 492, 529, 540, 542, 548, 552, 555, 560, 564, 600, 655, 725, 758, 762, 768, 786, 790, 835, 860, 883, 942, 974, 992], [43, 126, 140, 186, 201, 207, 213, 229, 235, 285, 294, 307, 336, 364, 449, 457, 498, 578, 615, 630, 643, 654, 661, 719, 740, 743, 760, 782, 795, 951, 976], [22, 57, 60, 87, 95, 98, 110, 124, 131, 143, 151, 217, 219, 230, 252, 256, 257, 296, 302, 306, 322, 325, 341, 349, 390, 462, 476, 477, 488, 572, 579, 595, 656, 711, 716, 722, 732, 738, 754, 826, 828, 850, 892, 914, 919, 940, 960], [0, 21, 46, 215, 245, 249, 263, 291, 367, 412, 414, 418, 437, 471, 517, 533, 547, 566, 613, 695, 697, 704, 793, 922, 955], [64, 181, 184, 205, 272, 344, 354, 362, 368, 378, 406, 432, 438, 453, 454, 588, 628, 652, 658, 701, 739, 766, 799, 809, 875, 885, 925, 930, 973, 978], [9, 105, 121, 134, 136, 141, 146, 150, 206, 266, 288, 309, 334, 346, 365, 369, 377, 396, 398, 403, 444, 473, 490, 499, 518, 545, 546, 553, 554, 601, 607, 612, 620, 666, 673, 678, 687, 783, 808, 815, 834, 894, 967, 971], [1, 78, 96, 119, 132, 133, 153, 175, 246, 387, 415, 596, 634, 638, 714, 780, 819, 830, 898, 939, 963], [42, 129, 237, 238, 239, 258, 293, 297, 312, 315, 345, 372, 410, 425, 435, 443, 468, 520, 534, 538, 569, 594, 627, 669, 691, 702, 803, 825, 872, 889, 902, 948, 985, 986, 995, 997], [14, 27, 38, 48, 58, 59, 159, 183, 218, 236, 295, 384, 388, 430, 446, 485, 493, 496, 616, 645, 682, 759, 761, 792, 804, 821, 886, 918, 923, 931, 949, 956, 999], [88, 109, 128, 138, 152, 228, 260, 279, 373, 470, 504, 522, 567, 576, 623, 657, 685, 712, 731, 746, 753, 820, 833, 842, 846, 882, 891, 936], [13, 16, 18, 51, 52, 72, 86, 100, 122, 130, 148, 154, 161, 198, 220, 232, 251, 267, 268, 305, 319, 323, 355, 357, 361, 370, 381, 382, 421, 503, 512, 523, 525, 526, 550, 559, 582, 599, 624, 626, 629, 632, 636, 675, 690, 692, 715, 729, 735, 741, 756, 763, 771, 788, 789, 797, 801, 805, 848, 858, 862, 868, 901, 905, 910, 933, 937, 944, 945, 954, 968, 981], [6, 29, 45, 77, 85, 117, 155, 171, 216, 343, 379, 401, 424, 448, 467, 481, 482, 505, 551, 609, 617, 631, 707, 751, 769, 816, 838, 861, 878, 959], [32, 179, 281, 290, 347, 389, 404, 455, 506, 508, 621, 770, 774, 881, 895, 953, 969, 980], [17, 41, 63, 108, 125, 176, 223, 328, 332, 413, 447, 557, 568, 625, 709, 713, 810, 857], [4, 11, 28, 74, 89, 127, 149, 162, 172, 187, 282, 284, 423, 452, 466, 519, 590, 598, 603, 633, 650, 744, 802, 817, 818, 832, 854, 998], [62, 83, 135, 164, 166, 168, 185, 195, 200, 271, 278, 299, 301, 324, 478, 483, 584, 604, 606, 644, 668, 717, 726, 755, 764, 775, 798, 890, 924, 926, 984], [5, 15, 23, 26, 70, 71, 92, 102, 103, 144, 180, 196, 199, 254, 277, 289, 316, 321, 380, 428, 429, 439, 458, 464, 480, 501, 549, 563, 589, 622, 635, 646, 648, 663, 688, 721, 750, 784, 785, 840, 879, 900, 911, 917, 938, 975, 991, 994], [8, 19, 33, 35, 190, 204, 226, 338, 385, 409, 411, 416, 460, 527, 528, 587, 597, 667, 703, 852, 921, 927, 934, 987, 990], [68, 147, 165, 189, 221, 419, 427, 461, 571, 593, 670, 672, 698, 720, 728, 733, 748, 773, 831, 863, 977], [7, 44, 99, 123, 173, 197, 211, 231, 270, 422, 451, 479, 532, 537, 544, 575, 577, 591, 602, 671, 679, 681, 699, 700, 718, 723, 736, 747, 752, 794, 837, 853, 856, 867, 870, 876, 904, 962, 972, 988], [53, 82, 169, 241, 276, 310, 317, 330, 337, 342, 360, 392, 436, 484, 521, 580, 583, 592, 642, 653, 765, 807, 814, 824, 884, 935, 941, 958, 965, 970, 979, 993], [49, 66, 67, 69, 76, 80, 81, 91, 104, 111, 139, 163, 170, 194, 214, 233, 243, 250, 255, 273, 292, 303, 326, 339, 374, 375, 391, 400, 456, 463, 489, 507, 514, 530, 535, 573, 585, 586, 611, 618, 619, 641, 647, 686, 694, 696, 706, 724, 727, 745, 781, 787, 800, 827, 866, 896, 899, 912, 950, 983], [25, 30, 65, 157, 174, 178, 210, 224, 264, 308, 353, 399, 408, 420, 440, 459, 500, 510, 513, 556, 605, 639, 651, 710, 776, 778, 871, 874, 888, 916, 929, 947], [47, 75, 84, 90, 93, 106, 107, 120, 142, 158, 167, 202, 247, 269, 331, 340, 351, 397, 441, 450, 487, 495, 502, 531, 539, 574, 581, 610, 649, 662, 708, 734, 737, 749, 843, 847, 855, 877, 880, 887, 908, 915, 957], [3, 54, 156, 222, 240, 242, 287, 359, 386, 393, 394, 417, 472, 659, 683, 730, 829, 907, 943, 996], [34, 56, 61, 113, 193, 209, 212, 227, 244, 253, 298, 304, 314, 350, 469, 494, 558, 570, 608, 660, 684, 689, 705, 767, 796, 822, 844, 864, 906, 920, 961], [640, 982, 541, 445, 497, 160, 118, 40, 192, 356, 248, 79, 115, 811, 836, 371, 188, 664, 259, 376, 536, 989, 335, 757, 742, 39, 812, 475, 327, 913, 50, 486, 318, 333, 511, 637, 112, 932, 31, 208, 363, 893, 964, 561, 524, 614, 515, 234, 562, 358, 262, 851, 225, 865, 952, 677, 841, 680, 869, 791, 114, 966, 434, 543, 897, 509, 516, 407, 909, 274, 300, 383, 839]]
#cmax=[0.15440715179600989, 0.15681430359201967, 0.17722145538802947, 0.27762860718403931, 0.30003575898004914, 0.30144291077605889, 0.30785006257206871, 0.31525721436807846, 0.32166436616408828, 0.32707151796009803, 0.32947866975610779, 0.33188582155211754, 0.34329297334812731, 0.36970012514413708, 0.39610727694014686, 0.42251442873615663, 0.44892158053216641, 0.47532873232817618, 0.50173588412418602, 0.52814303592019585]
#label_array=[20, 20, 20, 14, 4, 16, 13, 1, 19, 15, 18, 20, 8, 5, 2, 17, 6, 10, 9, 3, 12, 7, 11, 20, 20, 18, 20, 16]

cmax=[0.018301693983736923, 0.036603387967473845, 0.054905081951210771, 0.07320677593494769, 0.09150846991868461, 0.10981016390242153, 0.12811185788615845, 0.14641355186989538, 0.16471524585363231, 0.18301693983736925, 0.20131863382110618, 1.2196203278048197, 0.23792202178858005, 0.25622371577231695, 0.27452540975605388, 0.29282710373979082, 0.31112879772352775, 0.32943049170726468, 0.34773218569100162, 0.36603387967473855]
label_array=[11, 11, 12, 6, 9, 10, 8, 10, 9, 7, 10, 9, 9, 7, 10, 11, 7, 10, 6, 8, 11, 5, 8, 6, 8, 7, 2, 10, 10, 3, 4, 8, 7, 1, 4]
pairwise_dist_mat=numpy.load('pmatrix_1000_vocab_250.dat.npy')
clusters=[[15, 21, 35, 39, 49, 57, 90, 93, 98, 128, 129, 159, 166, 189, 190, 201, 225, 228, 264, 279, 295, 307, 314, 318, 359, 390, 392, 394, 397, 426, 430, 434, 440, 454, 460, 461, 463, 479, 488, 532, 541, 545, 561, 570, 576, 579, 587, 604, 633, 641, 647, 674, 675, 676, 685, 695, 696, 712, 720, 728, 735, 791, 805, 808, 835, 837, 859, 862, 874, 875, 893, 900, 909, 921, 924, 954, 957, 969, 981], [27, 53, 70, 77, 157, 179, 199, 266, 308, 324, 499, 518, 580, 595, 748, 786, 799, 834, 953], [17, 30, 60, 100, 293, 351, 422, 509, 514, 530, 645, 693, 708, 878, 916, 926, 980], [59, 150, 162, 400, 511, 548, 609, 615, 671, 773, 787, 806, 864], [202, 212, 271, 309, 411, 428, 458, 493, 558, 600, 614, 638, 777, 811, 844, 857, 915, 935, 994], [32, 56, 88, 174, 248, 250, 259, 302, 322, 425, 492, 540, 549, 583, 665, 711, 763, 848, 891, 908, 961, 970], [116, 121, 151, 227, 331, 358, 405, 413, 427, 473, 477, 546, 640, 683, 704, 706, 722, 746, 772, 781, 887, 934], [69, 72, 86, 89, 95, 104, 125, 155, 200, 205, 223, 226, 262, 384, 435, 438, 491, 519, 535, 537, 591, 631, 653, 684, 686, 687, 713, 723, 730, 793, 849, 860, 884, 914, 925, 928, 949, 952, 972, 973, 977], [185, 210, 211, 229, 240, 292, 344, 379, 414, 448, 475, 500, 521, 596, 599, 642, 649, 673, 725, 726, 729, 780, 902, 943], [6, 20, 22, 52, 224, 230, 234, 241, 267, 283, 284, 452, 536, 556, 594, 626, 663, 705, 747, 766, 790], [38, 42, 85, 103, 106, 152, 207, 220, 300, 313, 333, 339, 386, 401, 437, 571, 603, 629, 736, 744, 756, 757, 794, 803, 870, 910, 956, 984, 988], [13, 14, 44, 47, 99, 108, 131, 134, 167, 204, 222, 247, 256, 261, 268, 325, 375, 416, 439, 445, 462, 467, 526, 528, 542, 555, 577, 624, 656, 670, 710, 739, 745, 749, 778, 795, 796, 802, 841, 869, 871, 880, 894, 933, 939, 944, 982, 990], [16, 101, 112, 124, 183, 203, 216, 217, 277, 291, 341, 353, 404, 424, 432, 447, 494, 533, 559, 589, 658, 661, 666, 738, 770, 792, 801, 804, 813, 898, 922, 931, 998, 999], [186, 242, 265, 366, 504, 517, 554, 621, 826, 828, 863, 938, 967], [2, 64, 132, 141, 177, 191, 274, 369, 433, 436, 476, 482, 486, 515, 531, 612, 648, 697, 816, 829, 847, 873, 899, 950], [3, 9, 18, 63, 84, 91, 115, 137, 146, 147, 169, 188, 208, 214, 219, 243, 254, 260, 281, 286, 310, 327, 336, 364, 372, 376, 380, 393, 402, 406, 410, 423, 429, 455, 483, 544, 593, 616, 620, 625, 632, 635, 637, 643, 655, 659, 672, 688, 692, 694, 707, 709, 715, 719, 727, 732, 751, 753, 767, 768, 775, 776, 782, 810, 812, 821, 842, 845, 868, 882, 905, 912, 932, 941, 947, 971], [34, 87, 102, 105, 133, 145, 209, 315, 330, 349, 373, 385, 449, 450, 502, 506, 547, 552, 569, 572, 601, 606, 617, 699, 815, 823, 839, 840, 861, 890, 964, 987, 993], [26, 28, 46, 51, 74, 75, 76, 135, 221, 231, 235, 236, 278, 355, 356, 371, 395, 472, 525, 529, 588, 605, 630, 650, 690, 737, 750, 807, 825, 858, 867, 888, 927], [62, 198, 239, 257, 337, 354, 474, 562, 765, 774, 797, 886, 985], [24, 136, 163, 270, 273, 294, 296, 297, 299, 301, 387, 415, 534, 585, 613, 634, 680, 721, 733, 783, 809, 817, 892, 920, 958], [25, 29, 33, 54, 67, 148, 172, 178, 195, 213, 246, 258, 272, 352, 378, 498, 524, 574, 607, 664, 668, 752, 755, 818, 896, 937, 951, 965, 992], [5, 94, 138, 165, 176, 197, 303, 312, 316, 334, 417, 431, 443, 457, 490, 543, 565, 652, 716, 814, 833, 872, 936, 979, 995], [41, 110, 127, 311, 321, 329, 361, 442, 469, 485, 689, 734, 876, 881, 930], [10, 12, 43, 78, 92, 182, 289, 317, 374, 418, 503, 619, 771, 820, 846], [37, 48, 269, 305, 557, 578, 654, 779, 850, 923, 962], [61, 142, 153, 253, 285, 298, 346, 391, 408, 444, 505, 527, 566, 611, 691, 831, 838, 877], [111, 154, 158, 168, 184, 206, 306, 342, 496, 513, 551, 581, 627, 830, 856, 978, 996], [31, 55, 58, 68, 80, 114, 117, 118, 126, 170, 215, 232, 263, 282, 328, 335, 381, 398, 403, 407, 419, 446, 453, 470, 487, 507, 512, 598, 602, 610, 622, 651, 660, 662, 718, 743, 832, 885, 897, 904, 917, 919, 959, 963, 966, 986], [23, 50, 73, 122, 187, 249, 255, 275, 280, 320, 338, 343, 350, 363, 368, 399, 456, 465, 510, 523, 539, 560, 573, 644, 677, 764, 785, 788, 789, 800, 819, 843, 889, 901, 913, 942, 948], [7, 8, 130, 139, 156, 164, 194, 196, 276, 288, 466, 480, 501, 563, 582, 623, 667, 681, 700, 714, 717, 741, 855, 907, 975], [19, 36, 65, 79, 83, 119, 120, 149, 161, 175, 238, 290, 412, 441, 451, 459, 481, 495, 497, 522, 567, 575, 590, 636, 657, 759, 761, 798, 836, 911, 955, 983, 991], [40, 66, 71, 319, 348, 389, 484, 520, 628, 679, 682, 701, 724, 731, 740, 895, 940, 989, 997], [11, 107, 140, 144, 193, 237, 287, 360, 388, 409, 489, 586, 754, 822, 827, 903, 960], [4, 81, 109, 171, 192, 233, 251, 252, 323, 347, 357, 377, 508, 564, 584, 608, 703, 760, 769, 883, 929, 946], [758, 82, 332, 173, 742, 180, 618, 181, 553, 96, 396, 45, 538, 866, 702, 370, 974, 879, 365, 0, 854, 976, 420, 698, 678, 218, 304, 478, 906, 340, 468, 345, 244, 639, 516, 550, 123, 383, 326, 362, 646, 851, 597, 97, 669, 945, 245, 421, 471, 852, 968, 762, 784, 1, 113, 853, 143, 592, 865, 367, 382, 160, 568, 824, 464, 918]]
num_groups=12
groups=[[] for i in range(num_groups)]
for i in range(len(clusters)):
	groups[label_array[i]-1]+=clusters[i]
	
pivot=[0 for i in range(num_groups)]
for i in range(num_groups):
	pivot[i]=random.choice(groups[i])

pivot_dist=[[] for i in range(num_groups)]	
for i in range(num_groups):
	for j in groups[i]:
		dist=pairwise_dist_mat[j,pivot[i]]
		pivot_dist[i].append(dist)
	
	
num_query=1
query_array=random.sample(range(1000),num_query)
prune_count=0	
query=query_array[0]
#initialize the top_k elements
top_k=[]
for i in range(10):
		
		dist=pairwise_dist_mat[query,groups[random.randint(0,num_groups-1)][i]]	
		heapq.heappush(top_k,-dist)


prune_count=0	
for cnt in range(num_query):
	query=query_array[cnt]
	top_k=[]
	for i in range(10):	
		dist=pairwise_dist_mat[query,groups[random.randint(0,num_groups-1)][i]]	
		heapq.heappush(top_k,-dist)		
	temp= [i for i in range(num_groups)]
	random.shuffle(temp)
	max_dist=-1*heapq.heappop(top_k)
	for i in temp:
		for j in range(len(groups[i])):
			if abs(pairwise_dist_mat[query,pivot[i]]-pivot_dist[i][j])-cmax[i]>max_dist:
				prune_count+=1
			else:
				dist=pairwise_dist_mat[query,groups[i][j]]
				if dist<max_dist:
					heapq.heappush(top_k,-dist)	
					max_dist=-1*heapq.heappop(top_k)

print prune_count/(1.0*num_query)

###########################################
top_k=list(prev_top_k)
prune_count=0
for cnt in range(num_query):
	query=query_array[cnt]
	top_k=[]
	for i in range(10):	
		dist=pairwise_dist_mat[query,groups[random.randint(0,num_groups-1)][i]]	
		heapq.heappush(top_k,-dist)	
		
	temp= [i for i in range(num_groups)]
	temp.reverse()
	max_dist=-1*heapq.heappop(top_k)
	for i in temp:
		for j in range(len(groups[i])):
			if abs(pairwise_dist_mat[query,pivot[i]]-pivot_dist[i][j])-cmax[i]>max_dist:
				prune_count+=1
			else:
				dist=pairwise_dist_mat[query,groups[i][j]]
				if dist<max_dist:
					heapq.heappush(top_k,-dist)	
					max_dist=-1*heapq.heappop(top_k)

#print prune_count/(num_query*1.0)

#best of 7 prunes 